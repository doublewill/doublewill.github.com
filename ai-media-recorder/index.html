<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>ai-media-recorder</title>
  <link rel="stylesheet" href="./style/index.css">
</head>
<body>
  <div class="container">
    <video id="js-video" controls></video>
    <div class="btn-list">
      <button class="btn btn-danger" onclick="start()">开始</button>
      <button class="btn btn-danger" onclick="stop()">结束</button>
      <button class="btn btn-danger" onclick="downloadVideo()">下载视频</button>
    </div>

    <canvas id="js-canvas"></canvas>
  </div>

	<script src="./ai-media-recorder.js"></script>
	<script>
    function $(id) {
      return document.getElementById(id)
    }

    let videoEl = $('js-video')
    let canvasEl = $('js-canvas')
    let contextEl = canvasEl.getContext('2d')
    let source = null
    let audioContext = new (window.AudioContext || window.webkitAudioContext)()

    let config = {
      width: 480,
      height: 320
    }

    videoEl.width = config.width
    videoEl.height = config.height
    canvasEl.width = config.width
    canvasEl.height = config.height
    let mediaRecorder = null
    let videoBlob = null
    let chunks = []
    let mediaStream = null
    let analyser = null

    function success(stream) {
      mediaRecorder = new MediaRecorder(stream, {
        audioBitsPerSecond : 16000,
        videoBitsPerSecond : 256000,
        mimeType : 'video/webm;codecs=vp9'
      })

      mediaRecorder.onstop = function(e) {
        videoBlob = new Blob(chunks, { type: 'video/mp4' })
        chunks = []
      }

      mediaRecorder.ondataavailable = function(e) {
        chunks.push(e.data)
      }
      if ("srcObject" in videoEl) {
        videoEl.srcObject = stream
      } else {
        videoEl.src = window.URL.createObjectURL(stream)
      }
      videoEl.onloadedmetadata = function(e) {
        videoEl.play();
      }
    }
    navigator.mediaDevices.getUserMedia({ audio: true, video: true })
      .then((stream)=> {
        success(stream)
      })
      .catch((err)=> {
        console.log(err.name + ": " + err.message)
      })
    function start() {
      mediaRecorder.start()
    }
    function stop() {
      mediaRecorder.stop()
    }
    function downloadVideo() {
      let a = document.createElement('a')
      a.href = window.URL.createObjectURL(videoBlob)
      a.download = new Date().getTime() + '.mp4'
      a.click()
    }
	</script>
</body>
</html>
